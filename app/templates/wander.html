{% extends 'base.html' %}
{% load static from staticfiles %}

{% block body %}
    <body>
        <div id="map" style="height:600px"></div>
        <div id="text"></div>
        <script async defer
          src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAaFIdtdCCgrHuTM4NDJL8hLPVdG60hWIc&callback=initMap">
        </script>

    </body>
{% endblock %}

{% block js %}
<script type="text/javascript">
    $(document).ready(function() {
        var URL = "{% url 'update_location' %}";
        var map;
        var text = document.getElementById("text");
        var y;
        var markers = [];
        var infoWindow;

        detectBrowser();
        getLocation();

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(initMap, showError);
            } else {
                text.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function initMap(position) {
            var lat = position.coords.latitude;
            var lon = position.coords.longitude;
            updateLocation(lat, lon);

            var latlon = new google.maps.LatLng(lat, lon);

            var mapOptions = {
                center:latlon,zoom:7,
                mapTypeId:google.maps.MapTypeId.ROADMAP,
                mapTypeControl:false,
                navigationControlOptions:{style:google.maps.NavigationControlStyle.SMALL}
            }

            map = new google.maps.Map(document.getElementById('map'), mapOptions);
            var marker = new google.maps.Marker({position:latlon,map:map,title:"You are here!"});
            infoWindow = new google.maps.InfoWindow();
        }

        function detectBrowser() {
            var useragent = navigator.userAgent;
            var mapdiv = document.getElementById("map");

            if (useragent.indexOf('iPhone') != -1 || useragent.indexOf('Android') != -1 ) {
                mapdiv.style.width = '100%';
                mapdiv.style.height = '100%';
            } else {
                mapdiv.style.width = '600px';
                mapdiv.style.height = '800px';
            }
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    x.innerHTML = "User denied the request for Geolocation."
                    break;
                case error.POSITION_UNAVAILABLE:
                    x.innerHTML = "Location information is unavailable."
                    break;
                case error.TIMEOUT:
                    x.innerHTML = "The request to get user location timed out."
                    break;
                case error.UNKNOWN_ERROR:
                    x.innerHTML = "An unknown error occurred."
                    break;
            }
        }

        function updateLocation(lat, lon) {
            var data = {'coords': lat + "," + lon};
            $.post('/update_location', data, function(response){
                var points = response.results;
                for (i in points) {
                    var lat = points[i]['lat'];
                    var lon = points[i]['lon'];
                    pos = new google.maps.LatLng(lat, lon);
                    var label = points[i]['label'];
                    var quote = points[i]['quote'];
                    var bookTitle = points[i]['book'];
                    var bookAuthor = points[i]['author']
                    var m = new google.maps.Marker({
                        position:pos,
                        map:map,
                        title:label,
                        quote:quote,
                        bookTitle:bookTitle,
                        bookAuthor:bookAuthor
                    });
                    google.maps.event.addListener(m, 'mouseover', (function(m){
                        return function() {
                            var content = '<strong>'+m.title+'</strong><br/><em>'+m.bookTitle+' - '+m.bookAuthor+'</em><br/>'+m.quote
                            infoWindow.setContent(content);
                            infoWindow.open(map, m);
                         }
                    })(m));
                    google.maps.event.addListener(m, 'click', (function(m){
                        return function() {
                            // Add link fun stuff that happens with marker is clicked!
                            console.log(m.title);
                         }
                    })(m));
                    markers.push(m);
                }
            });
        }
    })
</script>
{% endblock %}
